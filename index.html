<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محاسبه شهریه تقریبی دانشجویان</title>
    <style>
        /* Your CSS styles remain the same */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Tahoma', sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .form-container { width: 100%; max-width: 700px; background: #fff; padding: 25px 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,.1); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 25px; }
        .radio-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; border-bottom: 1px solid #e0e0e0; padding-bottom: 20px; }
        .radio-group label { cursor: pointer; padding: 10px 15px; border-radius: 5px; transition: all .3s ease; }
        .radio-group input[type="radio"] { display: none; }
        .radio-group input[type="radio"]:checked+label { background-color: #3498db; color: #fff; font-weight: 700; }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .form-row { margin-bottom: 15px; }
        .form-row label { display: block; margin-bottom: 5px; font-weight: 500; }
        select, input[type=number] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        select:disabled { background-color: #f2f2f2; cursor: not-allowed; }
        .result-box { margin-top: 20px; padding: 15px; background-color: #eaf6ff; border: 1px solid #bce0fd; border-radius: 5px; font-weight: 700; text-align: center; font-size: 1.1em; }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        th, td { padding: 12px; text-align: center; border: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
<div class="form-container">
    <h2>محاسبه شهریه تقریبی دانشجویان</h2>
    <div class="radio-group">
        <input type="radio" id="type-uni" name="tuition-type" value="form-a" checked>
        <label for="type-uni">شهریه واحدهای دانشگاهی</label>
        <input type="radio" id="type-self" name="tuition-type" value="form-b">
        <label for="type-self">شهریه واحدهای خودگردان</label>
        <input type="radio" id="type-currency" name="tuition-type" value="form-c">
        <label for="type-currency">شهریه ارزی</label>
    </div>

    <div id="form-a" class="form-section active">
        <h3>شهریه واحدهای دانشگاهی</h3>
        <div class="form-row">
            <label for="degree-select-a">مقطع تحصیلی:</label>
            <select id="degree-select-a"></select>
        </div>
        <div class="form-row">
            <label for="field-group-select-a">گروه / رشته تحصیلی:</label>
            <select id="field-group-select-a" disabled></select>
        </div>
        <div class="form-row">
            <label for="level-select-a">سطح واحد:</label>
            <select id="level-select-a" disabled></select>
        </div>
        <div id="variable-tuition-section-a" style="display: none;">
            <h4>شهریه متغیر (تعداد واحدها را وارد کنید)</h4>
            <table><tbody id="variable-units-tbody-a"></tbody></table>
        </div>
        <div id="result-base-a" class="result-box" style="display: none;"></div>
        <div id="result-variable-a" class="result-box" style="display: none;"></div>
        <div id="result-total-a" class="result-box" style="display: none;"></div>
    </div>

    <div id="form-b" class="form-section">
        <h3>شهریه واحدهای خودگردان</h3>
        <p>این بخش برای نمایش نیاز به پیاده‌سازی مشابه بخش اول دارد.</p>
    </div>

    <div id="form-c" class="form-section">
        <h3>شهریه ارزی</h3>
        <p>این بخش برای نمایش نیاز به پیاده‌سازی مشابه بخش اول دارد.</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Form A Elements ---
        const degreeSelect = document.getElementById('degree-select-a');
        const fieldGroupSelect = document.getElementById('field-group-select-a');
        const levelSelect = document.getElementById('level-select-a');
        const variableTbody = document.getElementById('variable-units-tbody-a');
        const variableSection = document.getElementById('variable-tuition-section-a');
        const resultBase = document.getElementById('result-base-a');
        const resultVariable = document.getElementById('result-variable-a');
        const resultTotal = document.getElementById('result-total-a');

        // --- Helper Functions ---
        const populateSelect = (selectEl, options, prompt = "انتخاب کنید...") => {
            selectEl.innerHTML = `<option value="">${prompt}</option>`;
            options.forEach(opt => selectEl.insertAdjacentHTML('beforeend', `<option value="${opt}">${opt}</option>`));
            selectEl.disabled = false;
        };

        const resetSelect = (selectEl) => {
            selectEl.innerHTML = '<option value="">...</option>';
            selectEl.disabled = true;
        };

        const hideResults = () => {
            variableSection.style.display = 'none';
            resultBase.style.display = 'none';
            resultVariable.style.display = 'none';
            resultTotal.style.display = 'none';
            variableTbody.innerHTML = '';
        };

        // --- Data Fetching and UI Logic ---

        // 1. Initialize the first dropdown on page load
        async function initializeDegrees() {
            try {
                const response = await fetch('/api/options/degrees');
                if (!response.ok) throw new Error('Network response was not ok');
                const degrees = await response.json();
                populateSelect(degreeSelect, degrees);
            } catch (error) {
                console.error('Failed to load degrees:', error);
            }
        }

        // 2. When a degree is selected, fetch its field groups
        degreeSelect.addEventListener('change', async () => {
            resetSelect(fieldGroupSelect);
            resetSelect(levelSelect);
            hideResults();
            const selectedDegree = degreeSelect.value;
            if (selectedDegree) {
                try {
                    const response = await fetch(`/api/options/field-groups?degree=${encodeURIComponent(selectedDegree)}`);
                    const fieldGroups = await response.json();
                    populateSelect(fieldGroupSelect, fieldGroups);
                } catch (error) {
                    console.error('Failed to load field groups:', error);
                }
            }
        });

        // 3. When a field group is selected, fetch its levels
        fieldGroupSelect.addEventListener('change', async () => {
            resetSelect(levelSelect);
            hideResults();
            const selectedFieldGroup = fieldGroupSelect.value;
            if (selectedFieldGroup) {
                try {
                    const response = await fetch(`/api/options/levels?fieldGroup=${encodeURIComponent(selectedFieldGroup)}`);
                    const levels = await response.json();
                    populateSelect(levelSelect, levels);
                } catch (error) {
                    console.error('Failed to load levels:', error);
                }
            }
        });

        // 4. When level is selected, show unit inputs and trigger calculation
        levelSelect.addEventListener('change', () => {
            // For simplicity, we hardcode the unit types.
            const unitTypes = ['نظری', 'عملی عمومی', 'عملی پایه', 'عملی اصلی', 'عملی تخصصی', 'عملی کلینیکی', 'عملی کارآموزی', 'عملی کارورزی', 'پایان نامه', 'رساله'];

            variableTbody.innerHTML = '';
            unitTypes.forEach(unitType => {
                variableTbody.insertAdjacentHTML('beforeend', `<tr><td>${unitType}</td><td><input type="number" class="variable-unit-input" data-unit-type="${unitType}" min="0" placeholder="0"></td></tr>`);
            });

            document.querySelectorAll('.variable-unit-input').forEach(input => {
                input.addEventListener('input', performCalculation);
            });

            variableSection.style.display = 'block';
            performCalculation(); // Perform initial calculation with 0 units
        });

        // 5. Main function to send selections to the server and get the result
        async function performCalculation() {
            const degree = degreeSelect.value;
            const fieldGroup = fieldGroupSelect.value;
            const level = levelSelect.value;

            if (!degree || !fieldGroup || !level) {
                hideResults();
                return;
            }

            // Gather all unit counts from the input fields
            const units = {};
            document.querySelectorAll('.variable-unit-input').forEach(input => {
                const unitType = input.dataset.unitType;
                const count = parseInt(input.value) || 0;
                // Only include unit types with a count greater than 0
                if (count > 0) {
                    units[unitType] = count;
                }
            });

            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ degree, fieldGroup, level, units }),
                });

                if (!response.ok) throw new Error('Calculation request failed.');

                const results = await response.json();

                // Update the UI with the results from the server
                resultBase.textContent = `شهریه ثابت: ${results.baseTuition}`;
                resultVariable.textContent = `جمع شهریه متغیر: ${results.variableTuition}`;
                resultTotal.textContent = `جمع کل شهریه: ${results.totalTuition}`;

                resultBase.style.display = 'block';
                resultVariable.style.display = 'block';
                resultTotal.style.display = 'block';

            } catch (error) {
                console.error('Error performing calculation:', error);
                resultTotal.textContent = 'خطا در برقراری ارتباط با سرور.';
                resultTotal.style.display = 'block';
            }
        }

        // Handle form switching
        document.querySelectorAll('input[name="tuition-type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.querySelectorAll('.form-section').forEach(form => form.classList.remove('active'));
                document.getElementById(e.target.value).classList.add('active');
            });
        });

        // Initial load
        initializeDegrees();
    });
</script>
</body>
</html>